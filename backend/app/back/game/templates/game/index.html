<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>Game Rooms</title>
</head>
<body>
	<!-- <div id="screen" style="position: relative; width: 640px; height: 480px; margin:0 auto; background-color: rgb(0, 0, 0);">
		<div id="paddle1" style="height: 100px; width: 15px; position: absolute; left: 10px; background-color: #ff964f;"></div>
		<div id="paddle2" style="height: 100px; width: 15px; position: absolute; left: 615px; background-color: #ff964f;"></div>
		<div id="ball" style="position: absolute; width: 21px; height: 21px; border-radius: 50%; background-color: #779ecb;"></div>
	</div> -->
	<div>
		<a id="Score1"></a>
		<a>   -------   </a>
		<a id="Score2"></a>
	</div>
	<canvas id="pongCanvas" width="640" height="480" style="position: relative; margin:0 auto;"></canvas>
	<button id="playButton" onclick="getMatch('c9b98db2bb356daeed2b6bf90a632fccfaffda8c')">Play tom</button>
	<button id="playButton" onclick="getMatch('0dc0a7b2cdbf8d150aac0c152bb1ea1bc94af9bf')">Play moise</button>
	<button id="playButton" onclick="getMatch('33890da45ab3c89a61f1e0ac4234c1c291bdc006')">Play guest</button>
	<button id="playButton" onclick="getMatch('311a804fa9d796abb307085ccb170a168817a634')">Play guest2</button>
	<button id="playButton" onclick="getMatch('492cc4d9f364b2f63f32510663fe780ccf18eff7')">Play maya</button>
	<button id="playButton" onclick="getMatch('2e318f34641e3320063cc96d3af353c1fe5eb00f')">Play abeille</button>
	<script>
		const canva = document.getElementById("pongCanvas");
		const ctx = canva.getContext("2d");
		ctx.fillStyle = "black";
		ctx.fillRect(0, 0, canva.width, canva.height);

		const paddleWidth = 15, paddleHeight = 100;
		let paddle2y = canva.height / 2 - paddleHeight / 2;
		let paddle1y = canva.height / 2 - paddleHeight / 2;
		let paddle1X = 10;
		let paddle2X = canva.width - 10 - paddleWidth;
		let ballRadius = 10.5;
		let ballX = canva.width / 2;
		let ballY = canva.height / 2 - paddleHeight / 2;

		function drawPaddle1(x, y) {
			ctx.fillStyle = "#FFFFFF";
			ctx.fillRect(x, y, paddleWidth, paddleHeight);
		}

		function drawPaddle2(x, y) {
			ctx.fillStyle = "#FFFFFF";
			ctx.fillRect(x, y, paddleWidth, paddleHeight);
		}

		function drawBall(x, y) {
			ctx.beginPath();
			ctx.arc(x, y, ballRadius, 0, Math.PI*2);
			ctx.fillStyle = "red";
			ctx.fill();
			ctx.closePath();
		}

		var matchSocket = 0;

// tom 256b2ccafa34a35a7dd9a7b5ac75e1294c238bd8
// moise f44c54dd904d41da988161d9794bd5db410537ee

		function getMatch(token) {
			const queueSocket = new WebSocket('ws://' + window.location.host +'/ws/game/queue/' + '?token=' + token);
			
			queueSocket.onopen = function(e) {
				queueSocket.send(JSON.stringify({
					'message': 'join',
				}));
			};

			queueSocket.onmessage = function(e) {
				const data = JSON.parse(e.data);
				console.log(data.response);
				if (data.response == 'match_found') {
					console.log('match found');
					launchMatch(data.match_id, token);
					queueSocket.close();
				}
			};	
		}

		function launchMatch(match_id, token) {
			scoreArray = [];
			const score1 = document.getElementById('Score1');
			const score2 = document.getElementById('Score2');

			const matchSocket = new WebSocket(
				'ws://'
				+ window.location.host
				+ '/ws/game/'
				+ match_id
				+ '/?token='
				+ token
				);
						
				
			matchSocket.onopen = function(e) {
				document.addEventListener('keydown', sendInputs, false);
				document.addEventListener('keyup', sendInputs, false);
				console.log('matchSocket open');
			};

			matchSocket.onmessage = function(e) {
				const data = JSON.parse(e.data);
				console.log("antilag");
				scoreArray = data.Score;
				score1.textContent = data.paddle1.score;
				score2.textContent = data.paddle2.score;
				
				ctx.fillStyle = "blue";
				ctx.fillRect(0, 0, canva.width, canva.height)
				console.log(data.ball.x);
				
				drawBall(data.ball.x, data.ball.y);
				drawPaddle1(data.paddle1.x, data.paddle1.y);
				drawPaddle2(data.paddle2.x, data.paddle2.y);
			};

			function sendInputs(e) {
				// if (e.keyCode != 83 && e.keyCode != 87)
				// 	return 
				if (e.type == 'keyup')
					input = 0;
				else if (e.keyCode == 83)
					input = 1;
				else if (e.keyCode == 87)
					input = -1
				matchSocket.send(JSON.stringify({
					'message': input,
				}));
			};
		}
		
		</script>
</body>
</html>
